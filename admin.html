<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin - Chat</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    background: #00aaff;
  }
  .container {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  .rooms {
    width: 30%;
    max-width: 280px;
    border-right: 1px solid #444;
    overflow-y: auto;
    background: #222;
  }
  .room {
    padding: 12px;
    cursor: pointer;
    border-bottom: 1px solid #333;
  }
  .room:hover {
    background: #333;
  }
  .messages {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #1e1e1e;
  }
  #messagesBox {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
  }
  .msg {
    margin: 5px 0;
    padding: 8px 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 6px;
    max-width: 80%;
  }
  .msg strong {
    color: #00aaff;
  }
  .input-area {
    display: flex;
    padding: 10px;
    border-top: 1px solid #444;
    background: #222;
  }
  .input-area input {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    margin-right: 10px;
    background: #333;
    color: white;
  }
  .input-area button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    background: #00aaff;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }
  .input-area button:hover {
    background: #0088cc;
  }
</style>
</head>
<body>
<header>Panel Admin - Chat</header>
<div class="container">
  <div class="rooms" id="rooms">
    <!-- Daftar user chat -->
  </div>
  <div class="messages">
    <div id="messagesBox"></div>
    <div class="input-area">
      <input id="reply" placeholder="Tulis balasan...">
      <button onclick="sendReply()">Kirim</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, onChildAdded, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAcFRkbZT3PD3BDObS-7T1769uH5Macvd0",
    authDomain: "reystore-support.firebaseapp.com",
    databaseURL: "https://reystore-support-default-rtdb.firebaseio.com",
    projectId: "reystore-support",
    storageBucket: "reystore-support.firebasestorage.app",
    messagingSenderId: "446513200960",
    appId: "1:446513200960:web:cbd40ca4315a8bf47044a5",
    measurementId: "G-YEBFKLREK5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const roomsDiv = document.getElementById('rooms');
  const messagesBox = document.getElementById('messagesBox');
  let currentChat = null;
  let unsubscribe = null;

  // List semua chat
  onChildAdded(ref(db, "chats"), (snap) => {
    const data = snap.val();
    const room = document.createElement('div');
    room.className = 'room';
    room.textContent = data.username || '(Tanpa nama)';
    room.onclick = () => openChat(snap.key);
    roomsDiv.appendChild(room);
  });

  function openChat(id) {
    currentChat = id;
    messagesBox.innerHTML = '';

    // Hapus listener lama (kalau ada)
    if (unsubscribe) unsubscribe();

    // Pasang listener baru
    const chatRef = ref(db, "chats/" + id + "/messages");
    unsubscribe = onChildAdded(chatRef, (s) => {
      const d = s.val();
      const div = document.createElement('div');
      div.className = 'msg';
      div.style.alignSelf = (d.sender === 'admin') ? 'flex-end' : 'flex-start';
      div.innerHTML = `<strong>${d.sender}:</strong> ${d.text}`;
      messagesBox.appendChild(div);
      messagesBox.scrollTop = messagesBox.scrollHeight;
    });
  }

  window.sendReply = function() {
    const text = document.getElementById('reply').value;
    if (!currentChat || !text) return;
    const msgRef = push(ref(db, "chats/" + currentChat + "/messages"));
    set(msgRef, { sender:"admin", text, time:Date.now() });
    document.getElementById('reply').value = '';
  }
</script>
</body>
</html>
